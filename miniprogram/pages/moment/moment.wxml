<!--momenté¡µé¢-->
<view 
  class="moment-container"
  bind:keyboardheightchange="onKeyboardShow"
  bind:keyboardhide="onKeyboardHide"
>
  <!-- é¡¶éƒ¨Banner -->
  <view class="banner">
    <!-- BannerèƒŒæ™¯å›¾ç‰‡ -->
    <image 
      src="./banner.jpg?v=2" 
      class="banner-image"
      mode="aspectFill"
    />
    <view class="banner-overlay">
      <!-- å·¦ä¸Šè§’ï¼šå¹´æœˆæ—¥ + å†œå†æ—¥æœŸ -->
      <view class="date-time">
        <view class="date">{{currentDate.year}}å¹´{{currentDate.month}}æœˆ{{currentDate.day}}æ—¥</view>
        <view class="lunar-date">{{lunarDate}}</view>
      </view>
      
      <!-- å·¦ä¸‹è§’ï¼šå¤©æ°”ä¿¡æ¯ -->
      <view class="weather-info-left" bindtap="refreshWeather">
        <view class="weather-temp">{{weatherInfo.temp}}Â°C</view>
        <view class="weather-desc">{{weatherInfo.desc}}</view>
      </view>
      
      <!-- å³ä¸Šè§’ï¼šå¤©æ°”å›¾æ ‡ -->
      <view class="weather-icon-top" bindtap="refreshWeather">
        <view class="weather-icon">{{weatherInfo.icon}}</view>
      </view>
      
      <!-- å³ä¸‹è§’ï¼šå€’è®¡æ—¶ -->
      <view class="countdown">
        <text class="countdown-text" wx:if="{{countdownDays > 0}}">{{countdownDays}} days to 9/17/2025</text>
        <text class="countdown-text" wx:elif="{{countdownDays === 0}}">Today is 9/17/2025!</text>
        <text class="countdown-text" wx:else>{{-countdownDays}} days since 9/17/2025</text>
      </view>
    </view>
  </view>

  <!-- åŠ¨æ€åˆ—è¡¨ -->
  <scroll-view 
    class="feed-scroll" 
    scroll-y="true"
    refresher-enabled="true"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onReachBottom"
    lower-threshold="100"
  >
    <view class="feed-list">
        <view 
          wx:for="{{posts}}" 
          wx:key="id" 
          class="moment-item {{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8' ? 'bubble-left' : 'bubble-right'}}"
          bindlongpress="onPostLongPress"
          data-id="{{item.id}}"
        >
      <!-- å·¦ä¾§å¤´åƒ -->
      <view wx:if="{{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8'}}" class="avatar-container left">
        <t-avatar 
          size="80rpx" 
          image="{{item.avatar}}" 
          class="moment-avatar"
        />
      </view>
      
        <!-- æ°”æ³¡å†…å®¹åŒºåŸŸ -->
        <view class="bubble-content {{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8' ? 'bubble-left-content' : 'bubble-right-content'}}">
          <!-- æ°”æ³¡ç®­å¤´ -->
          <view class="bubble-arrow {{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8' ? 'bubble-arrow-left' : 'bubble-arrow-right'}}"></view>
        
        <!-- æ–‡å­—å†…å®¹ -->
        <view wx:if="{{item.text}}" class="moment-text">{{item.text}}</view>
        
        <!-- å›¾ç‰‡å±•ç¤º -->
        <view wx:if="{{item.images && item.images.length > 0}}" class="moment-images">
          <!-- å•å¼ å›¾ç‰‡ - å¤§å›¾å±•ç¤º -->
          <view wx:if="{{item.images.length === 1}}" class="single-image-container">
            <image 
              src="{{item.images[0]}}" 
              class="single-image"
              mode="aspectFill"
              data-url="{{item.images[0]}}"
              data-postid="{{item.id}}"
              bind:tap="onImageTap"
            />
          </view>
          
          <!-- å¤šå¼ å›¾ç‰‡ - ä¹å®«æ ¼å±•ç¤º -->
          <view wx:else class="grid-images-container">
            <view 
              wx:for="{{item.images}}" 
              wx:for-item="image" 
              wx:key="*this"
              class="grid-image-item"
            >
              <image 
                src="{{image}}" 
                class="grid-image"
                mode="aspectFill"
                data-url="{{image}}"
                data-postid="{{item.id}}"
                bind:tap="onImageTap"
              />
            </view>
          </view>
        </view>
        
        <!-- æ—¶é—´å’Œè¯„è®ºæŒ‰é’® -->
        <view class="moment-time-container">
          <text class="moment-time">{{item.time}}</text>
          <view 
            class="comment-button" 
            bindtap="onCommentTap" 
            data-postid="{{item.id}}"
          >
            <text class="comment-button-icon">ğŸ’¬</text>
          </view>
        </view>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comment-section" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comments-list">
            <!-- ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è¯„è®ºï¼Œä¸ä¾èµ–æ¡ä»¶åˆ¤æ–­ -->
            <view 
              wx:for="{{item.comments}}" 
              wx:for-item="comment"
              wx:key="id" 
              class="comment-item"
              catchlongpress="onCommentLongPress"
              data-commentid="{{comment.id}}"
              data-postid="{{item.id}}"
            >
              <view class="comment-content">
                <text class="comment-author">{{comment.authorName}}ï¼š</text>
                <text class="comment-text">{{comment.content}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å³ä¾§å¤´åƒ -->
      <view wx:if="{{item.openid !== 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8'}}" class="avatar-container right">
        <t-avatar 
          size="80rpx" 
          image="{{item.avatar}}" 
          class="moment-avatar"
        />
      </view>
    </view>
    
    <!-- åŠ è½½æ›´å¤šçŠ¶æ€ -->
    <view class="load-more-container" wx:if="{{loading}}">
      <view class="loading-spinner">
        <view class="spinner"></view>
      </view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <!-- åˆ°åº•æç¤º -->
    <view class="end-tip" wx:if="{{!hasMore && posts.length > 0}}">
      <text class="end-tip-text">æ²¡æœ‰æ›´å¤šå†…å®¹äº†</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{posts.length === 0 && !loading}}">
      <text class="empty-text">æš‚æ— åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§~</text>
    </view>
  </view>
  </scroll-view>

  <!-- å‘å¸ƒå¼¹çª— -->
  <t-popup 
    visible="{{showPublish}}" 
    bind:visible-change="onPublishVisibleChange"
    placement="bottom"
    class="publish-popup"
  >
    <view class="publish-content">
      <view class="publish-header">
        <text class="publish-title">å‘å¸ƒæ–°åŠ¨æ€</text>
        <view class="publish-close" bind:tap="hidePublishPopup">Ã—</view>
      </view>
      
      <view class="publish-form">
        <!-- æ–‡å­—è¾“å…¥ -->
        <t-textarea 
          value="{{publishText}}"
          bind:change="onTextChange"
          placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."
          maxlength="500"
          class="publish-textarea"
          adjust-position="{{true}}"
          hold-keyboard="{{false}}"
          cursor-spacing="{{100}}"
          auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          disable-default-padding="{{false}}"
          fixed="{{true}}"
        />
        
        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ - åªåœ¨æœ‰å›¾ç‰‡æˆ–éœ€è¦æ·»åŠ æ—¶æ˜¾ç¤º -->
        <view class="image-upload-section" wx:if="{{publishImages.length > 0 || publishImages.length < 9}}">
          <view class="upload-tip" wx:if="{{publishImages.length === 0}}">é€‰æ‹©å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰</view>
          <view class="image-grid">
            <!-- å·²é€‰æ‹©çš„å›¾ç‰‡ -->
            <view 
              wx:for="{{publishImages}}" 
              wx:key="index" 
              class="image-item"
            >
              <image 
                src="{{item.url || item}}" 
                class="uploaded-image"
                mode="aspectFill"
              />
              <view 
                class="remove-btn" 
                bindtap="removeImage" 
                data-index="{{index}}"
              >Ã—</view>
            </view>
            
            <!-- æ·»åŠ æŒ‰é’® -->
            <view 
              wx:if="{{publishImages.length < 9}}" 
              class="add-image-btn" 
              bindtap="chooseImage"
            >
              <text class="add-icon">+</text>
            </view>
          </view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="publish-actions">
          <view 
            class="publish-reset-native"
            bind:tap="resetPublish"
          >
            <text class="button-text">æ¸…ç©º</text>
          </view>
          <view 
            class="publish-submit-native {{publishing ? 'publishing' : ''}}"
            bind:tap="submitPublish"
          >
            <text class="button-text">{{publishing ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ'}}</text>
          </view>
          
          <!-- æ—¶é—´è®¾ç½® - å‘å¸ƒæŒ‰é’®ä¸Šæ–¹å³ä¸‹è§’ -->
          <view class="time-setting-corner-small">
            <picker
              mode="multiSelector"
              range="{{timePickerRange}}"
              value="{{timePickerValue}}"
              bind:change="onTimePickerChange"
              bind:columnchange="onTimePickerColumnChange"
            >
              <view class="time-display-corner-small">
                <text class="time-value-corner-small">{{formattedPublishTime}}</text>
              </view>
            </picker>
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- åˆ é™¤é€‰é¡¹å¼¹çª— -->
  <t-popup 
    visible="{{showDeleteOptions}}" 
    bind:visible-change="onDeleteOptionsVisibleChange"
    placement="bottom"
    class="delete-options-popup"
  >
    <view class="delete-options-content">
      <view class="delete-options-title">æ“ä½œé€‰é¡¹</view>
      <view class="delete-options-actions">
        <view 
          class="delete-option-item delete-option"
          bindtap="confirmDelete"
        >
          <text class="delete-option-text">åˆ é™¤åŠ¨æ€</text>
        </view>
        <view 
          class="delete-option-item cancel-option"
          bindtap="cancelDelete"
        >
          <text class="cancel-option-text">å–æ¶ˆ</text>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
  <view 
    wx:if="{{showImagePreview}}" 
    class="image-preview-overlay"
    bindtap="onImagePreviewClose"
  >
    <view class="image-preview-content" catchtap="">
      <image 
        src="{{previewImageUrl}}" 
        class="preview-image"
        mode="aspectFit"
        style="transform: scale({{imageScale}}) translate({{imageTranslateX}}px, {{imageTranslateY}}px);"
        bindtouchstart="onImageTouchStart"
        bindtouchmove="onImageTouchMove"
        bindtouchend="onImageTouchEnd"
        bindlongpress="onImageLongPress"
      />
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª— -->
  <t-popup 
    visible="{{showCommentPopup}}" 
    bind:visible-change="onCommentPopupVisibleChange"
    placement="bottom"
    class="comment-popup"
  >
    <view class="comment-popup-content">
      <view class="comment-popup-header">
        <text class="comment-popup-title">å‘è¡¨è¯„è®º</text>
        <view 
          class="comment-submit-btn-small {{commentSubmitting ? 'submitting' : ''}}"
          bind:tap="submitComment"
        >
          <text class="comment-submit-icon">{{commentSubmitting ? '...' : 'âœ“'}}</text>
        </view>
      </view>
      
      <!-- è¯„è®ºè¾“å…¥åŒºåŸŸ -->
      <view class="comment-input-section">
        <t-textarea 
          value="{{commentText}}"
          bind:change="onCommentTextChange"
          placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
          maxlength="200"
          class="comment-textarea"
          adjust-position="{{true}}"
          hold-keyboard="{{true}}"
          cursor-spacing="{{50}}"
          auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          disable-default-padding="{{false}}"
          fixed="{{false}}"
        />
      </view>
    </view>
  </t-popup>

  <!-- è¯„è®ºåˆ é™¤ç¡®è®¤å¼¹çª— -->
  <t-popup 
    visible="{{showCommentDeleteOptions}}" 
    bind:visible-change="onCommentDeleteOptionsVisibleChange"
    placement="bottom"
    class="comment-delete-options-popup"
  >
    <view class="comment-delete-options-content">
      <view class="comment-delete-options-title">æ“ä½œé€‰é¡¹</view>
      <view class="comment-delete-options-actions">
        <view 
          class="comment-delete-option-item delete-option"
          bindtap="confirmCommentDelete"
        >
          <text class="comment-delete-option-text">åˆ é™¤è¯„è®º</text>
        </view>
        <view 
          class="comment-delete-option-item cancel-option"
          bindtap="cancelCommentDelete"
        >
          <text class="cancel-option-text">å–æ¶ˆ</text>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- Toastæç¤º -->
  <t-toast id="t-toast" />
</view>

<!-- å‘å¸ƒæŒ‰é’® - åªåœ¨æœ‰æƒé™æ—¶æ˜¾ç¤º -->
<view 
  wx:if="{{showFab}}"
  class="publish-fab-native"
  bind:tap="showPublishPopup"
  style="position: fixed !important; right: 30rpx !important; bottom: 30rpx !important; z-index: 99999 !important; width: 80rpx !important; height: 80rpx !important; background-color: #666666 !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15) !important;"
>
  <text class="fab-icon">+</text>
  <!-- å‘å¸ƒæç¤ºæ–‡å­— -->
  <view class="publish-tip">å‘å¸ƒ</view>
</view>