<!--moment页面-->
<view 
  class="moment-container"
  bind:keyboardheightchange="onKeyboardShow"
  bind:keyboardhide="onKeyboardHide"
>
  <!-- 顶部Banner -->
  <view class="banner">
    <!-- Banner背景图片 -->
    <image 
      src="./banner.jpg?v=2" 
      class="banner-image"
      mode="aspectFill"
    />
    <view class="banner-overlay">
      <!-- 左上角：年月日 + 农历日期 -->
      <view class="date-time">
        <view class="date">{{currentDate.year}}年{{currentDate.month}}月{{currentDate.day}}日</view>
        <view class="lunar-date">{{lunarDate}}</view>
      </view>
      
      <!-- 左下角：天气信息 -->
      <view class="weather-info-left" bindtap="refreshWeather">
        <view class="weather-temp">{{weatherInfo.temp}}°C</view>
        <view class="weather-desc">{{weatherInfo.desc}}</view>
      </view>
      
      <!-- 右上角：天气图标 -->
      <view class="weather-icon-top" bindtap="refreshWeather">
        <view class="weather-icon">{{weatherInfo.icon}}</view>
      </view>
      
      <!-- 右下角：倒计时 -->
      <view class="countdown">
        <text class="countdown-text" wx:if="{{countdownDays > 0}}">{{countdownDays}} days to 9/17/2025</text>
        <text class="countdown-text" wx:elif="{{countdownDays === 0}}">Today is 9/17/2025!</text>
        <text class="countdown-text" wx:else>{{-countdownDays}} days since 9/17/2025</text>
      </view>
    </view>
  </view>

  <!-- 动态列表 -->
  <scroll-view 
    class="feed-scroll" 
    scroll-y="true"
    refresher-enabled="true"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onReachBottom"
    lower-threshold="100"
  >
    <view class="feed-list">
        <view 
          wx:for="{{posts}}" 
          wx:key="id" 
          class="moment-item {{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8' ? 'bubble-left' : 'bubble-right'}}"
          bindlongpress="onPostLongPress"
          data-id="{{item.id}}"
        >
      <!-- 左侧头像 -->
      <view wx:if="{{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8'}}" class="avatar-container left">
        <t-avatar 
          size="80rpx" 
          image="{{item.avatar}}" 
          class="moment-avatar"
        />
      </view>
      
        <!-- 气泡内容区域 -->
        <view class="bubble-content {{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8' ? 'bubble-left-content' : 'bubble-right-content'}}">
          <!-- 气泡箭头 -->
          <view class="bubble-arrow {{item.openid === 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8' ? 'bubble-arrow-left' : 'bubble-arrow-right'}}"></view>
        
        <!-- 文字内容 -->
        <view wx:if="{{item.text}}" class="moment-text">{{item.text}}</view>
        
        <!-- 图片展示 -->
        <view wx:if="{{item.images && item.images.length > 0}}" class="moment-images">
          <!-- 单张图片 - 大图展示 -->
          <view wx:if="{{item.images.length === 1}}" class="single-image-container">
            <image 
              src="{{item.images[0]}}" 
              class="single-image"
              mode="aspectFill"
              data-url="{{item.images[0]}}"
              data-postid="{{item.id}}"
              bind:tap="onImageTap"
            />
          </view>
          
          <!-- 多张图片 - 九宫格展示 -->
          <view wx:else class="grid-images-container">
            <view 
              wx:for="{{item.images}}" 
              wx:for-item="image" 
              wx:key="*this"
              class="grid-image-item"
            >
              <image 
                src="{{image}}" 
                class="grid-image"
                mode="aspectFill"
                data-url="{{image}}"
                data-postid="{{item.id}}"
                bind:tap="onImageTap"
              />
            </view>
          </view>
        </view>
        
        <!-- 时间 -->
        <view class="moment-time">{{item.time}}</view>
      </view>
      
      <!-- 右侧头像 -->
      <view wx:if="{{item.openid !== 'okU9A1yvJI1WS_NfmEo0wMY9Lyl8'}}" class="avatar-container right">
        <t-avatar 
          size="80rpx" 
          image="{{item.avatar}}" 
          class="moment-avatar"
        />
      </view>
    </view>
    
    <!-- 加载更多状态 -->
    <view class="load-more-container" wx:if="{{loading}}">
      <view class="loading-spinner">
        <view class="spinner"></view>
      </view>
      <text class="loading-text">加载中...</text>
    </view>
    
    <!-- 到底提示 -->
    <view class="end-tip" wx:if="{{!hasMore && posts.length > 0}}">
      <text class="end-tip-text">没有更多内容了</text>
    </view>
    
    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{posts.length === 0 && !loading}}">
      <text class="empty-text">暂无动态，快来发布第一条吧~</text>
    </view>
  </view>
  </scroll-view>

  <!-- 发布弹窗 -->
  <t-popup 
    visible="{{showPublish}}" 
    bind:visible-change="onPublishVisibleChange"
    placement="bottom"
    class="publish-popup"
  >
    <view class="publish-content">
      <view class="publish-header">
        <text class="publish-title">发布新动态</text>
        <view class="publish-close" bind:tap="hidePublishPopup">×</view>
      </view>
      
      <view class="publish-form">
        <!-- 文字输入 -->
        <t-textarea 
          value="{{publishText}}"
          bind:change="onTextChange"
          placeholder="这一刻的想法..."
          maxlength="500"
          class="publish-textarea"
          adjust-position="{{true}}"
          hold-keyboard="{{false}}"
          cursor-spacing="{{100}}"
          auto-height="{{true}}"
          show-confirm-bar="{{false}}"
          disable-default-padding="{{false}}"
          fixed="{{true}}"
        />
        
        <!-- 图片上传区域 - 只在有图片或需要添加时显示 -->
        <view class="image-upload-section" wx:if="{{publishImages.length > 0 || publishImages.length < 9}}">
          <view class="upload-tip" wx:if="{{publishImages.length === 0}}">选择图片（最多9张）</view>
          <view class="image-grid">
            <!-- 已选择的图片 -->
            <view 
              wx:for="{{publishImages}}" 
              wx:key="index" 
              class="image-item"
            >
              <image 
                src="{{item.url || item}}" 
                class="uploaded-image"
                mode="aspectFill"
              />
              <view 
                class="remove-btn" 
                bindtap="removeImage" 
                data-index="{{index}}"
              >×</view>
            </view>
            
            <!-- 添加按钮 -->
            <view 
              wx:if="{{publishImages.length < 9}}" 
              class="add-image-btn" 
              bindtap="chooseImage"
            >
              <text class="add-icon">+</text>
            </view>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="publish-actions">
          <view 
            class="publish-reset-native"
            bind:tap="resetPublish"
          >
            <text class="button-text">清空</text>
          </view>
          <view 
            class="publish-submit-native {{publishing ? 'publishing' : ''}}"
            bind:tap="submitPublish"
          >
            <text class="button-text">{{publishing ? '发布中...' : '发布'}}</text>
          </view>
          
          <!-- 时间设置 - 发布按钮上方右下角 -->
          <view class="time-setting-corner-small">
            <picker
              mode="multiSelector"
              range="{{timePickerRange}}"
              value="{{timePickerValue}}"
              bind:change="onTimePickerChange"
              bind:columnchange="onTimePickerColumnChange"
            >
              <view class="time-display-corner-small">
                <text class="time-value-corner-small">{{formattedPublishTime}}</text>
              </view>
            </picker>
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 删除选项弹窗 -->
  <t-popup 
    visible="{{showDeleteOptions}}" 
    bind:visible-change="onDeleteOptionsVisibleChange"
    placement="bottom"
    class="delete-options-popup"
  >
    <view class="delete-options-content">
      <view class="delete-options-title">操作选项</view>
      <view class="delete-options-actions">
        <view 
          class="delete-option-item delete-option"
          bindtap="confirmDelete"
        >
          <text class="delete-option-text">删除动态</text>
        </view>
        <view 
          class="delete-option-item cancel-option"
          bindtap="cancelDelete"
        >
          <text class="cancel-option-text">取消</text>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 图片预览弹窗 -->
  <view 
    wx:if="{{showImagePreview}}" 
    class="image-preview-overlay"
    bindtap="onImagePreviewClose"
  >
    <view class="image-preview-content" catchtap="">
      <image 
        src="{{previewImageUrl}}" 
        class="preview-image"
        mode="aspectFit"
        style="transform: scale({{imageScale}}) translate({{imageTranslateX}}px, {{imageTranslateY}}px);"
        bindtouchstart="onImageTouchStart"
        bindtouchmove="onImageTouchMove"
        bindtouchend="onImageTouchEnd"
        bindlongpress="onImageLongPress"
      />
    </view>
  </view>

  <!-- Toast提示 -->
  <t-toast id="t-toast" />
</view>

<!-- 发布按钮 - 只在有权限时显示 -->
<view 
  wx:if="{{showFab}}"
  class="publish-fab-native"
  bind:tap="showPublishPopup"
  style="position: fixed !important; right: 30rpx !important; bottom: 30rpx !important; z-index: 99999 !important; width: 80rpx !important; height: 80rpx !important; background-color: #666666 !important; border-radius: 50% !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.15) !important;"
>
  <text class="fab-icon">+</text>
  <!-- 发布提示文字 -->
  <view class="publish-tip">发布</view>
</view>