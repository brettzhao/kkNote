# 定时推送触发器排查指南

## 为什么定时推送没有触发？

### 1. 检查定时触发器是否正确部署

**步骤：**
1. 在微信开发者工具中，打开"云开发"控制台
2. 进入"云函数" -> "scheduledSubscribePush"
3. 点击"触发器"标签页
4. 检查是否有名为 `scheduledSubscribePush` 的定时触发器
5. 检查触发器状态是否为"已启用"

**如果触发器不存在或未启用：**
- 重新上传并部署云函数（右键点击 `scheduledSubscribePush` 文件夹 -> "上传并部署：云端安装依赖"）
- 确保 `config.json` 文件已正确上传

### 2. 检查云函数日志

**步骤：**
1. 在微信开发者工具中，打开"云开发"控制台
2. 进入"云函数" -> "scheduledSubscribePush"
3. 点击"日志"标签页
4. 查看是否有定时触发的日志记录

**如果没有任何日志：**
- 说明定时触发器可能没有执行
- 检查触发器配置是否正确

**如果有日志但显示错误：**
- 查看错误信息，根据错误信息进行修复

### 3. 检查 subscribe 集合中是否有数据

**步骤：**
1. 在微信开发者工具中，打开"云开发"控制台
2. 进入"数据库" -> "subscribe" 集合
3. 检查是否有数据
4. 检查数据格式是否正确：
   - 必须有 `openid` 字段
   - 必须有 `templateId` 字段，且值为 `'Jg6qHMqCG24_bGVVPwtHjeBxQYB0urT0REeah9g7zfc'`
   - 建议有 `subscribeCount` 字段（大于0）

**如果集合中没有数据：**
- 需要在个人页面点击"当前订阅次数"进行订阅
- 订阅成功后会创建 subscribe 记录

**如果数据格式不正确：**
- 检查 `templateId` 是否正确
- 检查 `openid` 是否存在

### 4. 检查定时触发器配置

**当前配置：**
```json
{
  "triggers": [
    {
      "name": "scheduledSubscribePush",
      "type": "timer",
      "config": "0 * * * * * *"
    }
  ]
}
```

**说明：**
- `"0 * * * * * *"` 表示每分钟的第0秒执行
- 微信云开发定时触发器最小间隔为 **1分钟**
- 触发器会在每分钟的第0秒执行

**如果配置不正确：**
- 检查 `config.json` 文件格式是否正确
- 确保 cron 表达式格式正确

### 5. 手动测试云函数

**步骤：**
1. 在微信开发者工具中，打开"云开发"控制台
2. 进入"云函数" -> "scheduledSubscribePush"
3. 点击"测试"按钮
4. 输入测试参数（可以为空）：
```json
{}
```
5. 点击"测试"按钮执行
6. 查看返回结果和日志

**如果手动测试成功：**
- 说明云函数代码没有问题
- 问题可能在于定时触发器配置

**如果手动测试失败：**
- 查看错误信息
- 根据错误信息修复代码

### 6. 检查云函数环境配置

**步骤：**
1. 在微信开发者工具中，打开"云开发"控制台
2. 进入"云函数" -> "scheduledSubscribePush"
3. 检查云函数是否已部署到正确的环境

**常见问题：**
- 云函数未部署到当前使用的环境
- 环境ID配置错误

### 7. 检查订阅消息模板配置

**步骤：**
1. 在微信公众平台，进入"小程序" -> "功能" -> "订阅消息"
2. 检查模板ID `Jg6qHMqCG24_bGVVPwtHjeBxQYB0urT0REeah9g7zfc` 是否存在
3. 检查模板状态是否为"已启用"

**如果模板不存在或未启用：**
- 需要先创建并启用订阅消息模板

### 8. 检查 miniprogram_state 配置

**当前配置：**
```javascript
miniprogram_state: 'developer' // 开发版使用 developer，正式版改为 formal
```

**说明：**
- `developer` 适用于开发版
- `trial` 适用于体验版
- `formal` 适用于正式版

**如果配置不正确：**
- 根据实际环境修改 `miniprogram_state` 的值

## 常见问题及解决方案

### 问题1：定时触发器没有执行

**可能原因：**
- 触发器未正确部署
- 触发器被禁用
- cron 表达式格式错误

**解决方案：**
1. 重新上传并部署云函数
2. 检查触发器状态
3. 验证 cron 表达式格式

### 问题2：云函数执行但没有推送

**可能原因：**
- subscribe 集合中没有数据
- 数据格式不正确
- 订阅次数为0
- 订阅消息模板配置错误

**解决方案：**
1. 检查 subscribe 集合数据
2. 验证数据格式
3. 确保 subscribeCount > 0
4. 检查订阅消息模板配置

### 问题3：推送失败（错误码43101）

**可能原因：**
- 用户订阅次数已用完
- 用户未授权订阅消息

**解决方案：**
1. 提示用户重新订阅
2. 检查用户订阅状态

### 问题4：定时触发器延迟执行

**可能原因：**
- 微信云开发定时触发器有延迟
- 系统负载较高

**解决方案：**
- 这是正常现象，定时触发器可能会有1-2分钟的延迟

## 调试建议

1. **先手动测试云函数**：确保云函数代码没有问题
2. **检查数据**：确保 subscribe 集合中有正确的数据
3. **查看日志**：通过云函数日志了解执行情况
4. **等待时间**：定时触发器可能需要等待1-2分钟才会执行
5. **检查触发器状态**：确保触发器已启用

## 联系支持

如果以上方法都无法解决问题，请：
1. 查看云函数详细日志
2. 检查微信开发者工具控制台错误信息
3. 查看微信云开发文档：https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html

